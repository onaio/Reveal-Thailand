# Index Case Generation

This is the process of transforming a Biophics index case to an OpenSRP Case Details event

### Index case

A Biophics index case is information about a particular patient which is collected when a malaria case is first reported. This information is then inserted into the **db_mhelath.dbo.index_case** table in the Biophics mssql database.

Below is a sample of what a single record looks like

```
{
  "case_id" : "131412000002655181103145034875",
  "p_site_id" : "2301110301",
  "p_site_name" : "ท่ากุ่มบน(ชายเขา)",
  "p_site_area" : "B1",
  "source_site_id" : "8800000000",
  "source_site_name" : null,
  "source_site_area" : null,
  "case_classification" : "Bf",
  "household_id" : "",
  "blood_draw_date" : "20181103",
  "investigtion_date" : "20181103",
  "ep1_create_date" : "2018-11-03 14:43:50.857",
  "ep3_create_date" : "2018-11-03 14:50:34.877",
  "house_number" : null,
  "patient_name" : "อัน",
  "patient_surname" : "พม่า",
  "patient_age" : 25,
  "species" : "V"
}
```

From the above

- **case_id** is a unique case identifier generated by the Biophics system
- **p_site_id**, **p_site_name** and **p_site_area** refers to the id, name and classification of the operational area where the patient lives
- **source_site_id**, **source_site_name** and **source_site_area** refers to the id, name and classification of the operational area where the patient was infected. It could be the same as where they live or different
- **case_classification** refers to the classification of the index case. _See [case classification](case-classification.md) for more info_
- **household_id** is the registered identifier of the structure (generated on the OpenSRP server) where the patient lives
- **blood_draw_date** and **investigation_date** usually the same day when the case was found/registered
- **ep1_create_date** and **ep3_create_date** are dates when the ep1 and the ep3 forms are created. Both of these forms are in the Biophics system, the ep1 is a notification form filled for all patients while the ep3 is filled when a patient tests positive for malaria
- **house_number** is used to identify the patients house. It is not always an actual number, it could sometimes be a fraction or even include the name of the street. It's basically anything that will help the health workers identify the house
- **patient_name**, **patient_surname** and **patient_age** are all details about the patient
- **species** refers to the specific Malaria species that the patient tested positive for. Could be one or multiple

The **db_mhelath.dbo.index_case** table also has an id column and a date_created column

### Transformation process

The index case generation Processor Group in NiFi is resopnsible for the transformation.

- There is a NiFi counter called **biophics_index_counter** which keeps track of what was the last index case id processed
- The flow starts by trying to pull this value from the NiFi counters. If the value is 0 or empty, as would be the case when initiating the process or incase NiFi had been restarted, we attempt to retrieve the value from the db_mhealth.dbo.index_case_raw_data table using the query `SELECT MAX(id) AS identifier FROM db_mhealth.dbo.index_case_raw_data`
- Once we have the last processed index case id (or 0), we use that to fetch any new IDs from the dbo.index_case table by querying for anything where the value of the id is higer
- On retrieving a new batch we update the counter and evaluate the records
- We check if the p_site matches the source_site or not, this determines if we are going to generate one event or two, one for each operational area
- We insert the record into the dbo.index_case_raw_data table with the status `started` to track that the process has began
- If a record has a house number we try to find the household id of that structure from the OpenSRP API. This is to be used when creating a case confirmation task. Each plan generated from an index case also has a case confirmation task which basically requires a health worker to confirm that the case actually exists in the area. If this task is attached to the actual structure it becomes easier for the health worker to find the patient/case
- We update the dbo.index_case_raw_data on progress with the status `searching for structure`
- The API endpoint used is `${base_url}/location/findByProperties?is_jurisdiction=false&properties_filter=houseNumber:${house_number}`. If a single structure is returned then that is used, otherwise if none or more than one are returned then the operational area will be used
- We then search for the jurisdiction by hitting the endpoint `${base_url}/location/findByProperties?is_jurisdiction=true&properties_filter=externalId:${jurisdiction_id}`, meanwhile updating the status in the dbo.index_case_raw_data table to `searching for jurisdiction`
- If no matching jurisdiction is found we simply update the status to `reveal jurisdiction_id not found` and terminate the process, otherwise we continue
- Before beginning the process to post this new event, we confirm that the event does not already exist by checking the index_case_raw_data using the query `SELECT COUNT(*) AS row_count FROM db_mhealth_preview.dbo.index_case_raw_data WHERE id = ${id} AND case_id = '${case_id}' AND focus_area_id = '${jurisdiction_id}' AND case_event IS NULL;`
- If it already exists the flowfile will be left 'hanging' on the connection, otherwise it will continue to generating an event payload
- Once payload is build the status in dbo.index_case_raw_data is updated to `complete` while the json object is posted

\***\*Improvement** - We should change this to only update the status to complete once it has received a 201 status code to avoid cases where the POST request fails but we've already updated the status

Below is a sample Case Details event:

```
 "events": [
   {
     "identifiers": {},
     "baseEntityId": "2611983",
     "eventDate": "2018-11-06T00:00:00.000+0000",
     "eventType": "Case Details",
     "formSubmissionId": "81604cb9-1911-4b05-b92f-c4a7ee310b25",
     "providerId": "nifi-user",
     "duration": 0,
     "entityType": "Case Details",
     "details": {
        "family_name": "วีดิ์",
        "focus_id": "2611983",
        "focus_name": "ท่ากุ่มบน(ชายเขา)",
        "surname": "ติด",
        "first_name": "วกด",
        "age": "46",
        "case_number": "811012565658901009999013141777",
        "case_classification": "Bz",
        "focus_status": "B1",
        "focus_reason": "Investigation",
        "species": "V",
        "investigtion_date": "2018-11-06T00:00:00.000+0000",
        "ep1_create_date" : "2018-11-07T10:10:27.673+0000",
        "ep3_create_date" : "2018-11-07T10:17:58.977+0000",
        "house_number" : "114"
     },
     "version": 1557860282617,
     "teamId": "",
     "dateCreated": "2018-11-07T10:17:58.977+0000",
     "type": "Event"
   }
 ]
}
```

---

### Places to check in case an event has not been generated

- Is the NiFi counter correct and fetching the latest records?
- Does the jurisdiction in the index case exist in OpenSRP?
- Are there any 'stuck' FlowFiles in the PG? sometimes requests to the API fail such as when looking for the structure, the juristiction or even when posting the final event payload
- What is the status in the dbo.index_case_raw_data table? this could give you a hint of what was happening just before the process failed
